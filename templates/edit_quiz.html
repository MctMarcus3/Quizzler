{% extends "layout.html" %}
{% block content %}
    <h2>Edit Quiz: {{ quiz.name }}</h2>

    <!-- Section to display flashed messages, especially for validation errors -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <article class="{{ category }}" aria-live="polite">{{ message }}</article>
            {% endfor %}
        {% endif %}
    {% endwith %}
        <!-- --- NEW: Interactive Validation Summary --- -->
    {% if validation_errors %}
      <article class="validation-summary">
        <header><strong>Please fix the following errors:</strong></header>
        <ul>
          {% for error in validation_errors %}
            <li>
              {% if error.index is defined %}
                <!-- This is a clickable link that JavaScript will handle -->
                <a href="#" class="jump-to-error" data-target-index="{{ error.index }}">
                  Question #{{ error.index + 1 }}: {{ error.text }}
                </a>
              {% else %}
                <!-- Non-question errors are just displayed as text -->
                {{ error.text }}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </article>
      <style>
        .validation-summary { 
            border: 1px solid var(--pico-color-red-500); 
            background-color: var(--pico-color-red-100); 
        }
        .jump-to-error {
            font-weight: 500;
        }
        .question-highlight {
            transition: background-color 0.2s ease-in-out;
            background-color: var(--pico-color-amber-200) !important;
        }
      </style>
    {% endif %}

    <!-- ADD THIS ENTIRE BLOCK FOR PIN MANAGEMENT -->
    <article>
        <div class="grid">
            <!-- Form to manually change the PIN -->
            <form method="post" action="{{ url_for('admin.change_pin', quiz_id=quiz.id) }}">
                <label for="new_pin">Quiz PIN
                    <input type="text" id="new_pin" name="new_pin" value="{{ quiz.pin }}" required>
                </label>
                <button type="submit">Change PIN</button>
            </form>
            <!-- Form to automatically regenerate a new PIN -->
            <form method="post" action="{{ url_for('admin.regenerate_pin', quiz_id=quiz.id) }}">
                <label for="regen_btn">Need a new PIN?</label>
                <button type="submit" id="regen_btn" class="secondary">Regenerate New PIN</button>
            </form>
        </div>
    </article>
    <hr>

    <!-- Append Questions from JSON Form -->
    <details>
        <summary>Append Questions from JSON</summary>
        <form method="post" action="{{ url_for('admin.append_questions', quiz_id=quiz.id) }}" enctype="multipart/form-data">
            <p><small>Upload a JSON file containing a "questions" list to add them to this quiz.</small></p>
            <input type="file" name="file" accept=".json" required>
            <button type="submit">Upload and Append</button>
        </form>
    </details>

    <form method="post" id="quiz-editor-form">
        <!-- The hidden input is now for compressed data -->
        <input type="hidden" name="quizDataCompressed" id="quiz-data-hidden-input">
        
        <!-- All visible form fields are now just for the JavaScript to read from -->
        <div class="grid">
            <label for="quiz_name">Quiz Name<input type="text" id="quiz_name" value="{{ quiz.name }}" required></label>
            <label for="quiz_timer">Timer (seconds)<input type="number" id="quiz_timer" value="{{ quiz.timer }}" required></label>
        </div>
        <label for="is_reviewable">
            <input type="checkbox" id="is_reviewable" role="switch" {% if quiz.get('is_reviewable') %}checked{% endif %}>
            Allow students to review their answers after completion?
        </label>

        <!-- MODIFIED: Instructions section with live preview -->
        <div class="form-group editor-section">
            <label for="instructions"><strong>Instructions (Supports Markdown &amp; MathJax)</strong></label>
            <textarea id="instructions" name="instructions" class="editor-input" rows="5">{{ quiz.get('instructions', '') }}</textarea>
            <label>Preview:</label>
            <article class="live-preview-container" id="instructions-preview"></article>
        </div>
        
        <fieldset><legend>Question Selection Mode</legend>
            <label><input type="radio" name="display_mode" value="question_count" {% if quiz.display_config.mode == 'question_count' or not quiz.display_config.mode %}checked{% endif %}> By Number of Questions</label>
            <label><input type="radio" name="display_mode" value="total_score" {% if quiz.display_config.mode == 'total_score' %}checked{% endif %}> By Target Score</label>
        </fieldset>
        
        <fieldset id="config-question-count">
            <p><small>Set how many questions of each type to randomly show.</small></p>
            <div class="grid">
                <label>Multiple Choice<input type="number" name="rule-multiple-choice" value="{{ quiz.display_config.parameters.get('multiple-choice', 0) }}" min="0"></label>
                <label>Short Answer<input type="number" name="rule-short-answer" value="{{ quiz.display_config.parameters.get('short-answer', 0) }}" min="0"></label>
                <label>Multiple-Select<input type="number" name="rule-multiple-select" value="{{ quiz.display_config.parameters.get('multiple-select', 0) }}" min="0"></label>
                <label>Multipart<input type="number" name="rule-multipart" value="{{ quiz.display_config.parameters.get('multipart', 0) }}" min="0"></label>
            </div>
        </fieldset>
        
        <fieldset id="config-total-score">
            <label>Target Score
                <input type="number" name="target_score" value="{{ quiz.display_config.target_score or 10 }}" min="1">
            </label>
        </fieldset>

        <fieldset>
            <legend>Practice Mode Settings</legend>
            <label for="practice_enabled">
                <input type="checkbox" id="practice_enabled" name="practice_enabled" role="switch" {% if quiz.get('practice_mode_config', {}).get('enabled') %}checked{% endif %}>
                Enable Practice Mode for this quiz
            </label>
            <label for="allow_student_selection">
                <input type="checkbox" id="allow_student_selection" name="allow_student_selection" role="switch" {% if quiz.get('practice_mode_config', {}).get('allow_student_selection') %}checked{% endif %}>
                Allow students to choose the number of practice questions
            </label>
            <label for="max_questions_limit">
                Max total questions a student can select in practice
                <input type="number" id="max_questions_limit" name="max_questions_limit" value="{{ quiz.get('practice_mode_config', {}).get('max_questions_limit', 10) }}" min="1">
            </label>
            <!-- ADD THIS BLOCK FOR PRACTICE PIN MANAGEMENT -->
            <label for="practice_pin">Practice Mode PIN</label>
            <div class="grid">
                <input type="text" id="practice_pin" name="practice_pin" value="{{ quiz.get('practice_pin', 'N/A') }}" readonly>
                <button type="button" id="regenerate-practice-pin-btn" class="secondary">Regenerate</button>
            </div>
            <!-- END OF ADDED BLOCK -->
        </fieldset>
        </fieldset>

        <button type="button" class="save-changes-btn contrast">Save Changes</button>
        <hr>
        <h3>Questions</h3>
        <div class="grid">
            <input type="search" id="question-search-input" placeholder="Search question text...">
            <nav id="pagination-controls"></nav>
        </div>

        <div id="questions-container">
            {% for question in quiz.questions %}
            <article class="question-article editor-section" id="question-{{ loop.index0 }}">
                <input type="hidden" class="question-type-input" value="{{ question.type }}">
                <header><b>Question <span class="q-number">{{ loop.index }}</span> (Type: {{ question.type }})</b><button type="button" class="secondary outline delete-question-btn">Delete</button></header>
                <!-- MODIFIED: Added editor-input class -->
                <label>Question Text</label><textarea class="question-text-input editor-input" rows="2" required>{{ question.text }}</textarea>
                
                {% if question.type in ['multiple-choice', 'multiple-select'] %}
                    <!-- MODIFIED: Added editor-input class -->
                    <label>Options (one per line)</label>
                    <textarea class="mc-options-textarea editor-input" rows="4" data-answer='{{ question.answer|default(none)|tojson|safe }}'>{{ question.options | join('\n') }}</textarea>
                    <label>Preview:</label>
                    <article class="live-preview-container question-preview"></article>
                    <fieldset class="answer-gui-container"><legend>Correct Answer(s)</legend></fieldset>
                    <label>Score<input type="number" class="question-score-input" value="{{ question.score | default(1) }}" required></label>
                {% elif question.type == 'multipart' %}
                    <div class="multipart-parts">
                        <!-- MODIFIED: Added preview container for the main question -->
                        <label>Preview:</label>
                        <article class="live-preview-container question-preview"></article>
                        <h4>Sub-Questions</h4>
                        {% for part in question.parts %}
                        <fieldset class="part-fieldset editor-section">
                            <header><small>Part ({{ part.type }})</small><button type="button" class="delete-part-btn">Remove</button></header>
                            <input type="hidden" class="part-type-input" value="{{ part.type }}">
                            <!-- MODIFIED: Added editor-input class -->
                            <label>Part Text</label><textarea class="part-text-input editor-input" rows="2">{{ part.text }}</textarea>
                            <!-- MODIFIED: Added preview container for each part -->
                            <label>Preview:</label>
                            <article class="live-preview-container part-preview"></article>
                            {% if part.type in ['multiple-choice', 'multiple-select'] %}
                                <!-- MODIFIED: Added editor-input class -->
                                <label>Options (one per line)</label>
                                <textarea class="mc-options-textarea editor-input" rows="3" data-answer='{{ part.answer|default(none)|tojson|safe }}'>{{ part.options | join('\n') }}</textarea>
                                <fieldset class="answer-gui-container"><legend>Correct Answer(s)</legend></fieldset>
                            {% else %}
                                <label>Answer<input type="text" class="part-answer-input" value="{{ part.answer }}"></label>
                            {% endif %}
                            <label>Score<input type="number" class="part-score-input" value="{{ part.score }}"></label>
                        </fieldset>
                        {% endfor %}
                    </div>
                    <footer><button type="button" class="add-part-btn" data-part-type="short-answer">Add Short Answer Part</button> <button type="button" class="add-part-btn" data-part-type="multiple-choice">Add MC Part</button> <button type="button" class="add-part-btn" data-part-type="multiple-select">Add MS Part</button></footer>
                
                {% else %}
                    <div class="grid"><label>Answer<input type="text" class="question-answer-input" value="{{ question.answer }}" required></label><label>Score<input type="number" class="question-score-input" value="{{ question.score | default(1) }}" required></label></div>
                    <label>Preview:</label>
                    <article class="live-preview-container question-preview"></article>
                {% endif %}
                

            </article>
            {% endfor %}
        </div>

        <fieldset><legend>Add New Question</legend>
            <div class="grid"><select id="new-question-type"><option value="short-answer">Short Answer</option><option value="multiple-choice">Multiple Choice</option><option value="multiple-select">Multiple-Select</option><option value="multipart">Multipart</option></select><button type="button" id="add-question-btn">Add Question</button></div>
        </fieldset>
        
        <button type="button" class="save-changes-btn contrast">Save Changes</button>
    </form>
    
    <!-- --- JAVASCRIPT TEMPLATES (MODIFIED) --- -->
    <template id="template-short-answer"><article class="question-article editor-section"><input type="hidden" class="question-type-input" value="short-answer"><header><b>Question <span class="q-number"></span> (Type: short-answer)</b> <button type="button" class="secondary outline delete-question-btn">Delete</button></header><label>Question Text</label><textarea class="question-text-input editor-input" rows="2" required></textarea><div class="grid"><label>Answer<input type="text" class="question-answer-input" required></label><label>Score<input type="number" class="question-score-input" value="1" required></label></div><label>Preview:</label><article class="live-preview-container question-preview"></article></article></template>
    <template id="template-multiple-choice"><article class="question-article editor-section"><input type="hidden" class="question-type-input" value="multiple-choice"><header><b>Question <span class="q-number"></span> (Type: multiple-choice)</b> <button type="button" class="secondary outline delete-question-btn">Delete</button></header><label>Question Text</label><textarea class="question-text-input editor-input" rows="2" required></textarea><label>Options (one per line)</label><textarea class="mc-options-textarea editor-input" rows="4"></textarea><fieldset class="answer-gui-container"><legend>Correct Answer(s)</legend></fieldset><label>Score<input type="number" class="question-score-input" value="1" required></label><label>Preview:</label><article class="live-preview-container question-preview"></article></article></template>
    <template id="template-multiple-select"><article class="question-article editor-section"><input type="hidden" class="question-type-input" value="multiple-select"><header><b>Question <span class="q-number"></span> (Type: multiple-select)</b> <button type="button" class="secondary outline delete-question-btn">Delete</button></header><label>Question Text</label><textarea class="question-text-input editor-input" rows="2" required></textarea><label>Options (one per line)</label><textarea class="mc-options-textarea editor-input" rows="4"></textarea><fieldset class="answer-gui-container"><legend>Correct Answer(s)</legend></fieldset><label>Score<input type="number" class="question-score-input" value="1" required></label><label>Preview:</label><article class="live-preview-container question-preview"></article></article></template>
    <template id="template-multipart">
    <article class="question-article editor-section">
        <input type="hidden" class="question-type-input" value="multipart">
        <header><b>Question <span class="q-number"></span> (Type: multipart)</b> <button type="button" class="secondary outline delete-question-btn">Delete</button></header>
        <label>Main Question Text</label><textarea class="question-text-input editor-input" rows="2" required></textarea>
        
        <!-- MOVED PREVIEW HERE -->
        <label>Preview:</label>
        <article class="live-preview-container question-preview"></article>

        <div class="multipart-parts"><h4>Sub-Questions</h4></div>
        <footer><button type="button" class="add-part-btn" data-part-type="short-answer">Add Short Answer Part</button> <button type="button" class="add-part-btn" data-part-type="multiple-choice">Add MC Part</button> <button type="button" class="add-part-btn" data-part-type="multiple-select">Add MS Part</button></footer>
    </article>
    </template>
    <template id="template-part-short-answer"><fieldset class="part-fieldset editor-section"><header><small>Part (short-answer)</small><button type="button" class="delete-part-btn">Remove</button></header><input type="hidden" class="part-type-input" value="short-answer"><label>Part Text</label><textarea class="part-text-input editor-input" rows="2"></textarea><div class="grid"><label>Answer<input type="text" class="part-answer-input"></label><label>Score<input type="number" class="part-score-input" value="1"></label></div><label>Preview:</label><article class="live-preview-container part-preview"></article></fieldset></template>
    <template id="template-part-multiple-choice"><fieldset class="part-fieldset editor-section"><header><small>Part (multiple-choice)</small><button type="button" class="delete-part-btn">Remove</button></header><input type="hidden" class="part-type-input" value="multiple-choice"><label>Part Text</label><textarea class="part-text-input editor-input" rows="2"></textarea><label>Options (one per line)</label><textarea class="mc-options-textarea editor-input" rows="3"></textarea><fieldset class="answer-gui-container"><legend>Correct Answer(s)</legend></fieldset><label>Score<input type="number" class="part-score-input" value="1"></label><label>Preview:</label><article class="live-preview-container part-preview"></article></fieldset></template>
    <template id="template-part-multiple-select"><fieldset class="part-fieldset editor-section"><header><small>Part (multiple-select)</small><button type="button" class="delete-part-btn">Remove</button></header><input type="hidden" class="part-type-input" value="multiple-select"><label>Part Text</label><textarea class="part-text-input editor-input" rows="2"></textarea><label>Options (one per line)</label><textarea class="mc-options-textarea editor-input" rows="3"></textarea><fieldset class="answer-gui-container"><legend>Correct Answer(s)</legend></fieldset><label>Score<input type="number" class="part-score-input" value="1"></label><label>Preview:</label><article class="live-preview-container part-preview"></article></fieldset></template>

    <!-- ADDED: Style and script tags for rendering -->
    <style>
        .editor-section { padding: 1rem; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 1.5rem; }
        .live-preview-container { padding: 0.5rem 1rem; background-color: #f8f9fa; border: 1px dashed #ddd; border-radius: 5px; min-height: 40px; margin-top: 0.5rem; }
            .option-preview-content {
        margin-left: 0.5em; /* Adds a nice space after the radio/checkbox */
        }
        /* This prevents marked.js from making each option a new paragraph, keeping it inline. */
        .option-preview-content p {
            display: inline;
        }
    </style>
    <script src="{{ url_for('static', filename='js/pako.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- --- JAVASCRIPT FOR DYNAMIC FUNCTIONALITY --- -->
<!-- ... all HTML and template tags above this line remain the same ... -->

<!-- --- Store full quiz data for JavaScript to use --- -->
<script id="quiz-data-json" type="application/json">
    {{ quiz.questions | tojson | safe }}
</script>

<script src="{{ url_for('static', filename='js/pako.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- --- REWRITTEN JAVASCRIPT FOR PAGINATION AND PERFORMANCE --- -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT & CONFIG ---
    const QUESTIONS_PER_PAGE = 25;
    let allQuestions = JSON.parse(document.getElementById('quiz-data-json').textContent);
    let filteredQuestions = [...allQuestions];
    let currentPage = 1;

    // --- DOM REFERENCES ---
    const mainForm = document.getElementById('quiz-editor-form');
    const hiddenInput = document.getElementById('quiz-data-hidden-input');
    const questionsContainer = document.getElementById('questions-container');
    const searchInput = document.getElementById('question-search-input');
    const paginationControls = document.getElementById('pagination-controls');

    // --- UTILITY FUNCTIONS ---
    const debounce = (func, delay) => {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    };
    
    const uint8ArrayToBase64 = (uint8Array) => {
        let CHUNK_SIZE = 0x8000;
        let index = 0;
        const length = uint8Array.length;
        let result = '';
        let slice;
        while (index < length) {
            slice = uint8Array.subarray(index, Math.min(index + CHUNK_SIZE, length));
            result += String.fromCharCode.apply(null, slice);
            index += CHUNK_SIZE;
        }
        return btoa(result);
    };

    // --- MARKDOWN & MATHJAX RENDERING ---
    const renderWithMath = (text) => {
        if (!text) return '';
        const inlineMath = [];
        const displayMath = [];
        let protectedText = text.replace(/\\\([\s\S]*?\\\)/g, (match) => {
            inlineMath.push(match);
            return `%%IMATH${inlineMath.length - 1}%%`;
        });
        protectedText = protectedText.replace(/\$\$[\s\S]*?\$\$/g, (match) => {
            displayMath.push(match);
            return `%%DMATH${displayMath.length - 1}%%`;
        });
        let html = marked.parse(protectedText);
        html = html.replace(/%%IMATH(\d+)%%/g, (match, i) => inlineMath[i]);
        html = html.replace(/%%DMATH(\d+)%%/g, (match, i) => displayMath[i]);
        return html;
    };

    function renderPreview(inputElement) {
        if (!inputElement) return;
        const scope = inputElement.closest('.editor-section');
        if (!scope) return;
        
        const previewBox = scope.querySelector('.question-preview, .part-preview');
        const textInput = scope.querySelector('.question-text-input, .part-text-input');
        if (previewBox && textInput) {
            previewBox.innerHTML = renderWithMath(textInput.value);
            if (typeof MathJax !== 'undefined' && typeof MathJax.typeset === 'function') {
                MathJax.typesetPromise([previewBox]);
            }
        }
    }
    
    function initializeAllPreviews() {
        document.querySelectorAll('.editor-input').forEach(renderPreview);
         if (typeof MathJax !== 'undefined' && typeof MathJax.typeset === 'function') {
            MathJax.typesetPromise();
        }
    }

    const updateAnswerGui = (optionsTextarea) => {
        const container = optionsTextarea.closest('.question-article, .part-fieldset');
        const guiContainer = container.querySelector('.answer-gui-container');
        const questionTypeInput = container.querySelector('.question-type-input, .part-type-input');
        if (!guiContainer || !questionTypeInput) return;

        // Get the authoritative correct answer from the master 'allQuestions' array.
        const article = optionsTextarea.closest('.question-article');
        const index = parseInt(article.dataset.index, 10);
        const questionData = allQuestions[index];
        let selectionToPreserve = [];

        if (questionData) {
            const partFieldset = optionsTextarea.closest('.part-fieldset');
            if (partFieldset) {
                // This is a sub-question (part) of a multipart question
                const partsContainer = article.querySelector('.multipart-parts');
                const parts = Array.from(partsContainer.querySelectorAll('.part-fieldset'));
                const partIndex = parts.indexOf(partFieldset);
                const partAnswer = questionData.parts?.[partIndex]?.answer;
                selectionToPreserve = partAnswer ? (Array.isArray(partAnswer) ? partAnswer : [partAnswer]) : [];
            } else {
                // This is a regular question
                const questionAnswer = questionData.answer;
                selectionToPreserve = questionAnswer ? (Array.isArray(questionAnswer) ? questionAnswer : [questionAnswer]) : [];
            }
        }
        
        const questionType = questionTypeInput.value;
        const inputType = (questionType === 'multiple-choice') ? 'radio' : 'checkbox';
        const uniqueName = `answer-gui-${Math.random()}`;
        
        guiContainer.innerHTML = '<legend>Correct Answer(s)</legend>';
        const options = optionsTextarea.value.split('\n').filter(opt => opt.trim() !== '');

        options.forEach(optionText => {
            const trimmedOption = optionText.trim();
            const label = document.createElement('label');
            const input = document.createElement('input');
            input.type = inputType;
            input.name = uniqueName;
            input.value = trimmedOption;
            if (selectionToPreserve.includes(trimmedOption)) {
                input.checked = true;
            }

            const previewSpan = document.createElement('span');
            previewSpan.className = 'option-preview-content';
            previewSpan.innerHTML = renderWithMath(optionText);

            label.appendChild(input);
            label.appendChild(previewSpan);
            guiContainer.appendChild(label);
        });

        // Explicitly tell MathJax to render the math inside the new options.
        if (typeof MathJax !== 'undefined' && typeof MathJax.typesetPromise === 'function') {
            MathJax.typesetPromise([guiContainer]);
        }
    };

    // --- FULL QUESTION ELEMENT CREATION ---
    const createQuestionElement = (questionData, originalIndex) => {
        const template = document.getElementById(`template-${questionData.type}`);
        const fragment = document.importNode(template.content, true);
        const article = fragment.querySelector('.question-article');
        
        article.id = `question-${originalIndex}`;
        article.dataset.index = originalIndex;

        article.querySelector('.q-number').textContent = originalIndex + 1;
        article.querySelector('.question-text-input').value = questionData.text;

        if (questionData.type === 'multiple-choice' || questionData.type === 'multiple-select') {
            article.querySelector('.mc-options-textarea').value = questionData.options ? questionData.options.join('\n') : '';
            article.querySelector('.question-score-input').value = questionData.score || 1;
        } else if (questionData.type === 'short-answer') {
            article.querySelector('.question-answer-input').value = questionData.answer || '';
            article.querySelector('.question-score-input').value = questionData.score || 1;
        } else if (questionData.type === 'multipart') {
            const partsContainer = article.querySelector('.multipart-parts');
            (questionData.parts || []).forEach(partData => {
                const partTemplate = document.getElementById(`template-part-${partData.type}`);
                const partFragment = document.importNode(partTemplate.content, true);
                const partFieldset = partFragment.querySelector('.part-fieldset');
                
                partFieldset.querySelector('.part-text-input').value = partData.text || '';
                partFieldset.querySelector('.part-score-input').value = partData.score || 1;

                if (partData.type === 'multiple-choice' || partData.type === 'multiple-select') {
                    partFieldset.querySelector('.mc-options-textarea').value = partData.options ? partData.options.join('\n') : '';
                } else {
                    partFieldset.querySelector('.part-answer-input').value = partData.answer || '';
                }
                partsContainer.appendChild(partFragment);
            });
        }
        return article;
    };
    
    // --- CORE PAGINATION & SEARCH LOGIC ---
    const renderPage = (page) => {
        currentPage = page;
        questionsContainer.innerHTML = '';

        const start = (page - 1) * QUESTIONS_PER_PAGE;
        const end = start + QUESTIONS_PER_PAGE;
        const questionsToRender = filteredQuestions.slice(start, end);

        questionsToRender.forEach(questionData => {
            const originalIndex = allQuestions.indexOf(questionData);
            const questionElement = createQuestionElement(questionData, originalIndex);
            questionsContainer.appendChild(questionElement);
        });

        // Initialize dynamic elements for the new page
        document.querySelectorAll('.mc-options-textarea').forEach(updateAnswerGui);
        initializeAllPreviews();
        renderPagination();
    };

    const renderPagination = () => {
        paginationControls.innerHTML = '';
        const pageCount = Math.ceil(filteredQuestions.length / QUESTIONS_PER_PAGE);
        if (pageCount <= 1) return;

        const prevButton = document.createElement('button');
        prevButton.type = 'button';
        prevButton.className = 'outline';
        prevButton.textContent = '‹ Prev';
        prevButton.disabled = currentPage === 1;
        prevButton.addEventListener('click', () => renderPage(currentPage - 1));

        const nextButton = document.createElement('button');
        nextButton.type = 'button';
        nextButton.className = 'outline';
        nextButton.textContent = 'Next ›';
        nextButton.disabled = currentPage === pageCount;
        nextButton.addEventListener('click', () => renderPage(currentPage + 1));
        
        const pageInfo = document.createElement('span');
        pageInfo.textContent = ` Page ${currentPage} of ${pageCount} (${filteredQuestions.length} questions) `;
        pageInfo.style.textAlign = 'center';
        pageInfo.style.lineHeight = 'var(--pico-form-element-height)';

        paginationControls.append(prevButton, pageInfo, nextButton);
    };

    const handleSearch = () => {
        const searchTerm = searchInput.value.toLowerCase().trim();
        if (!searchTerm) {
            filteredQuestions = [...allQuestions];
        } else {
            filteredQuestions = allQuestions.filter(q => 
                (q.text && q.text.toLowerCase().includes(searchTerm)) ||
                (q.parts && q.parts.some(p => p.text && p.text.toLowerCase().includes(searchTerm)))
            );
        }
        renderPage(1);
    };

    // --- DATA SYNC (DOM -> JAVASCRIPT STATE) ---
    const updateQuestionDataFromDOM = (element) => {
        const article = element.closest('.question-article');
        if (!article) return;
        
        const index = parseInt(article.dataset.index, 10);
        if (isNaN(index)) return;

        const qType = article.querySelector('.question-type-input').value;
        const qText = article.querySelector('.question-text-input').value;
        let questionData = { text: qText, type: qType };

        if (qType === 'multipart') {
            questionData.parts = [];
            article.querySelectorAll('.part-fieldset').forEach(part => {
                const pType = part.querySelector('.part-type-input').value;
                const pText = part.querySelector('.part-text-input').value;
                let pData = { text: pText, type: pType, score: parseInt(part.querySelector('.part-score-input').value) || 1 };
                if (pType === 'multiple-select') {
                    pData.answer = Array.from(part.querySelectorAll('.answer-gui-container input:checked')).map(el => el.value);
                    pData.options = part.querySelector('.mc-options-textarea').value.split('\n').filter(Boolean).map(s => s.trim());
                } else if (pType === 'multiple-choice') {
                    const checkedRadio = part.querySelector('.answer-gui-container input:checked');
                    pData.answer = checkedRadio ? checkedRadio.value : null;
                    pData.options = part.querySelector('.mc-options-textarea').value.split('\n').filter(Boolean).map(s => s.trim());
                } else {
                    pData.answer = part.querySelector('.part-answer-input').value;
                }
                questionData.parts.push(pData);
            });
        } else {
            questionData.score = parseInt(article.querySelector('.question-score-input').value) || 1;
            if (qType === 'multiple-select') {
                questionData.answer = Array.from(article.querySelectorAll('.answer-gui-container input:checked')).map(el => el.value);
                questionData.options = article.querySelector('.mc-options-textarea').value.split('\n').filter(Boolean).map(s => s.trim());
            } else if (qType === 'multiple-choice') {
                const checkedRadio = article.querySelector('.answer-gui-container input:checked');
                questionData.answer = checkedRadio ? checkedRadio.value : null;
                questionData.options = article.querySelector('.mc-options-textarea').value.split('\n').filter(Boolean).map(s => s.trim());
            } else {
                questionData.answer = article.querySelector('.question-answer-input').value;
            }
        }
        allQuestions[index] = questionData;
    };


    // --- EVENT LISTENERS ---
    searchInput.addEventListener('input', debounce(handleSearch, 300));
    
    // Listen for changes inside the questions container to keep `allQuestions` array in sync
    questionsContainer.addEventListener('change', (e) => updateQuestionDataFromDOM(e.target));
    questionsContainer.addEventListener('input', debounce((e) => {
        updateQuestionDataFromDOM(e.target);
        if(e.target.classList.contains('editor-input')){
            renderPreview(e.target);
        }
        if (e.target.matches('.mc-options-textarea')) {
            updateAnswerGui(e.target);
        }
    }, 250));

    // General event delegation for add/delete buttons
    document.body.addEventListener('click', (e) => {
        if (e.target.matches('.jump-to-error')) {
            e.preventDefault();
            const index = parseInt(e.target.dataset.targetIndex, 10);
            if (isNaN(index)) return;

            const targetPage = Math.floor(index / QUESTIONS_PER_PAGE) + 1;
            
            // If we are not already on the correct page, render it.
            if (currentPage !== targetPage) {
                renderPage(targetPage);
            }

            // Use setTimeout to ensure the element exists after a potential page render
            setTimeout(() => {
                const targetElement = document.getElementById(`question-${index}`);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Add a temporary highlight for better visual feedback
                    targetElement.classList.add('question-highlight');
                    setTimeout(() => {
                        targetElement.classList.remove('question-highlight');
                    }, 2000); // Highlight lasts for 2 seconds
                }
            }, 100); // A short delay is enough
        }

        if (e.target.matches('.delete-question-btn')) {
            e.preventDefault();
            const article = e.target.closest('.question-article');
            const index = parseInt(article.dataset.index, 10);
            if (confirm('Are you sure you want to delete this question?')) {
                allQuestions.splice(index, 1);
                handleSearch(); // Re-filter and re-render
            }
        }
        if (e.target.matches('.delete-part-btn')) {
            e.preventDefault();
            if (confirm('Are you sure you want to delete this part?')) {
                e.target.closest('.part-fieldset').remove();
            }
        }
        if (e.target.matches('.add-part-btn')) {
            e.preventDefault();
            addPart(e.target.closest('.question-article'), e.target.dataset.partType);
        }
    });

    mainForm.addEventListener('input', debounce((e) => {
        // Update the live preview if the user is typing in an editor box
        if (e.target.classList.contains('editor-input')) {
            renderPreview(e.target);
        }
        // Update the multiple-choice GUI if options are changed
        if (e.target.matches('.mc-options-textarea')) {
            updateAnswerGui(e.target);
        }
        // Update the backing JavaScript data model from the DOM element that changed
        updateQuestionDataFromDOM(e.target);
    }, 200));

    mainForm.addEventListener('change', (e) => {
        // This targets checkboxes and radio buttons in the answer GUI.
        if (e.target.matches('.answer-gui-container input')) {
            updateQuestionDataFromDOM(e.target);
        }
    });
    
    // Save button logic
    document.querySelectorAll('.save-changes-btn').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.save-changes-btn').forEach(btn => {
                btn.setAttribute('aria-busy', 'true');
                btn.textContent = 'Compressing & Saving...';
            });
            
            // The build object is now simpler as it uses the JS array as the source of truth
            const quizData = {
                name: document.getElementById('quiz_name').value,
                timer: parseInt(document.getElementById('quiz_timer').value),
                instructions: document.getElementById('instructions').value,
                is_reviewable: document.getElementById('is_reviewable').checked,
                practice_pin: document.getElementById('practice_pin').value,
                practice_mode_config: {
                    enabled: document.getElementById('practice_enabled').checked,
                    allow_student_selection: document.getElementById('allow_student_selection').checked,
                    max_questions_limit: parseInt(document.getElementById('max_questions_limit').value, 10)
                },
                display_config: {
                    mode: document.querySelector('input[name="display_mode"]:checked').value,
                    parameters: {
                        'multiple-choice': parseInt(document.querySelector('input[name="rule-multiple-choice"]').value),
                        'short-answer': parseInt(document.querySelector('input[name="rule-short-answer"]').value),
                        'multiple-select': parseInt(document.querySelector('input[name="rule-multiple-select"]').value),
                        'multipart': parseInt(document.querySelector('input[name="rule-multipart"]').value),
                    },
                    target_score: parseInt(document.querySelector('input[name="target_score"]').value)
                },
                questions: allQuestions
            };

            const jsonString = JSON.stringify(quizData);
            const compressed = pako.deflate(jsonString);
            const base64Encoded = uint8ArrayToBase64(compressed);
            hiddenInput.value = base64Encoded;
            mainForm.submit();
        });
    });

    // --- INITIALIZATION ---
    
    // Handle validation error from server
    const errorIndices = {{ error_indices | tojson if error_indices is defined else 'null' }};
    
    if (errorIndices && errorIndices.length > 0) {
        const firstErrorIndex = errorIndices[0];
        const errorPage = Math.floor(firstErrorIndex / QUESTIONS_PER_PAGE) + 1;
        renderPage(errorPage);
        
        setTimeout(() => {
            errorIndices.forEach(index => {
                const errorArticle = document.getElementById(`question-${index}`);
                if (errorArticle) {
                    errorArticle.style.border = '2px solid var(--pico-color-red-500)';
                }
            });
            const firstErrorArticle = document.getElementById(`question-${firstErrorIndex}`);
            if (firstErrorArticle) {
                    firstErrorArticle.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 0);

    } else {
        // Standard initial render if there are no errors.
        renderPage(1);
    }
});
</script>
{% endblock %}